<%#
LuCI - Lua Configuration Interface
Copyright 2008-2009 Steven Barth <steven@midlink.org>
Copyright 2008-2011 Jo-Philipp Wich <xm@subsignal.org>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id$

-%>

<%-
	require "bit"
	require "luci.sys"
	require "luci.tools.webadmin"
	require "nixio.fs"	

	--get message from AC-app
	local preamble = "viamanag"
	local cmdRecArray = {}
	local apNameArray = {}
	local modelArray = {}
	local ipAddrArray = {}
	local macAddrArray = {}
	local channelArray = {}
	local statusArray = {}
	local profileArray = {}
	local groupArray = {}
	apNumIndex = 1

	local socket = require"socket"
	local host   = "192.168.1.225"
	local port   = "1111"
	local data, err = socket.connect(host, port)
	if not data then
		--fail(err)
	else
		data:setoption("tcp-nodelay", true)
		data:settimeout(10)
		data:send(preamble.."APListRequestStart".."\n")
		while apNumIndex <= 255 do
			cmdRecArray[apNumIndex], err = data:receive()

			if err then 
				break 
			end
			if (string.find(cmdRecArray[apNumIndex], preamble.."APListRequestEnd")) then
				break;
			else
			end
			if (string.find(cmdRecArray[apNumIndex], preamble.."APListRequestStart")) then
				apNumIndex = apNumIndex+1
			end
		end
		data:close()
	end

	--get ap list message to varibale array test
	local i = 1
	local element
	while i < apNumIndex do
		element = "APName="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				apNameArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				apNameArray[i] = strTmp
			end
		end
		element = "Model="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				modelArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				modelArray[i] = strTmp
			end
		end
		element = "IPAddress="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				ipAddrArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				ipAddrArray[i] = strTmp
			end
		end
		element = "MACAddress="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				macAddrArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				macAddrArray[i] = strTmp
			end
		end
		element = "Channel="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				channelArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				channelArray[i] = strTmp
			end
		end
		element = "Status="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				statusArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				statusArray[i] = strTmp
			end
		end
		element = "Profile="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				profileArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				profileArray[i] = strTmp
			end
		end
		element = "Group="
		if string.find(cmdRecArray[i], element) then
			local strTmp = string.sub(cmdRecArray[i],string.find(cmdRecArray[i], element),-1)
			strTmp = string.sub(strTmp,string.len(element)+1,-1)
			if string.find(strTmp, " ") then
				groupArray[i] = string.sub(strTmp,1,string.find(strTmp, " ")-1)
			else
				groupArray[i] = strTmp
			end
		end

		i = i+1
	end


	tabRedir     = luci.http.formvalue("redir", true)
	tabRedir1    = luci.http.formvalue("redir1", true)

	local stra = "Shuant Test"
-%>

<%+header%>

<style type="text/css">
	span:target {
		color: blue;
		text-decoration: underline;
	}
</style>

<form method="post" action="<%=controller%>/admin/ViaView/ApConfig">

<input id="ApName" type="hidden" name="ApName"/>

<div class="cbi-map" id="cbi-network">
	<h2><a id="content" name="content"><%:AP List%></a></h2>
	<div class="cbi-map-descr"><%:The AP list for this AC to control%></div>

<h1>AP number is: <%=pcdata(apNumIndex-1)%></h1>

	<fieldset class="cbi-section" id="cbi-table-table">
		<legend><%_Information for <abbr title="Access Point">AP</abbr>-List%></legend>

		<div class="cbi-section-node">
			<table class="cbi-section-table">
				<tr class="cbi-section-table-titles">
					<th class="cbi-section-table-cell"><%:AP Name%></th>
					<th class="cbi-section-table-cell"><%:Model%></th>
					<th class="cbi-section-table-cell"><%:IP Address%></th>
					<th class="cbi-section-table-cell"><%:MAC Address%></th>
					<th class="cbi-section-table-cell"><%:Channel(GHz/GHz)%></th>
					<th class="cbi-section-table-cell"><%:Status%></th>
					<th class="cbi-section-table-cell"><%:Profile%></th>
					<th class="cbi-section-table-cell"><%:Group%></th>
					<th class="cbi-section-table-cell"><%:Modify%></th>
				</tr>
				<% 
					local i = 1
					while i < apNumIndex do
				%>
				<tr class="cbi-section-table-row cbi-rowstyle-<%=(style and 1 or 2)%>">
					<td class="cbi-value-field"><%=pcdata(apNameArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(modelArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(ipAddrArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(macAddrArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(channelArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(statusArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(profileArray[i])%></td>
					<td class="cbi-value-field"><%=pcdata(groupArray[i])%></td>
					<td class="cbi-value-field"> <input type="submit" class="cbi-button cbi-button-edit" style="width:100px" onclick="document.getElementById('ApName').value='<%=pcdata(apNameArray[i])%>'"  name="cbid.table.1._term" id="cbid.table.1._term" title="Edit this AP"  value="Edit" />
					</td>
					<!--<td class="cbi-value-field"> <input type="button" class="cbi-button cbi-button-edit" style="width:100px"  onclick="location.href='<%=controller%>/admin/ViaView/ApConfig?ApName=<%=pcdata(apNameArray[i])%>&amp;num=<%=pcdata(i)%>&amp;num2=<%=i%>'" name="cbid.table.1._term" id="cbid.table.1._term" title="Edit this AP"  value="Edit" />
					</td>
					-->
				</tr>
				<% 	i=i+1 end %>
			</table>
		</div>
	</fieldset>
	<br />

</div>
</form>

<%+footer%>
